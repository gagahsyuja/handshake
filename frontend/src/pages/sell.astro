---
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="Sell Product - Handshake">
  <div class="min-h-[80vh] py-12 px-6">
    <div class="max-w-3xl mx-auto">
      <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">List a New Product</h1>
        <p class="text-gray-600">Fill in the details to start selling</p>
      </div>

      <div id="auth-required" class="hidden card p-8 text-center">
        <div class="text-6xl mb-4">üîí</div>
        <h2 class="text-2xl font-bold mb-2">Authentication Required</h2>
        <p class="text-gray-600 mb-6">You need to login to list products</p>
        <a href="/login" class="btn btn-primary">Login Now</a>
      </div>

      <div id="sell-form-container" class="hidden">
        <div class="card p-8">
          <form id="sell-form" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Product Title *
              </label>
              <input
                type="text"
                name="title"
                required
                class="input"
                placeholder="e.g. iPhone 13 Pro Max 256GB"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Category *
              </label>
              <select name="category_id" required class="input">
                <option value="">Select a category</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Description *
              </label>
              <textarea
                name="description"
                required
                rows="4"
                class="input"
                placeholder="Describe your product in detail..."
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Price (Rp) *
              </label>
              <input
                type="number"
                name="price"
                required
                min="0"
                step="1000"
                class="input"
                placeholder="100000"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Image URL (optional)
              </label>
              <input
                type="url"
                name="image_url"
                class="input"
                placeholder="https://example.com/image.jpg"
              />
              <p class="text-xs text-gray-500 mt-1">
                Enter a valid URL to an image of your product
              </p>
            </div>

            <div class="border-t border-gray-200 pt-6">
              <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                <span>üìç</span>
                Seller Location (for COD midpoint)
              </h3>
              <p class="text-sm text-gray-600 mb-4">
                Set your location so we can calculate a fair meeting point when buyers place orders.
              </p>

              <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">
                  Address *
                </label>
                <input
                  type="text"
                  id="seller-address-input"
                  class="input"
                  placeholder="Enter your address or city"
                />

                <div class="grid sm:grid-cols-2 gap-3">
                  <button id="seller-geocode-btn" type="button" class="btn btn-secondary w-full">
                    <span>üìç</span>
                    Find Location
                  </button>
                  <button id="seller-current-location-btn" type="button" class="btn btn-secondary w-full">
                    <span>üéØ</span>
                    Use Current Location
                  </button>
                </div>

                <div id="seller-location-result" class="hidden">
                  <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-sm font-semibold text-green-900 mb-1">Location set:</p>
                    <p id="seller-found-address" class="text-sm text-green-800"></p>
                    <p id="seller-found-coords" class="text-xs text-green-700 mt-1"></p>
                  </div>
                </div>

                <div id="seller-location-warning" class="hidden p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm"></div>
              </div>
            </div>

            <div id="error-message" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm"></div>

            <div id="success-message" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm"></div>

            <div class="flex gap-4">
              <button id="sell-submit-btn" type="submit" class="btn btn-primary flex-1">
                <span>üì¶</span>
                List Product
              </button>
              <a href="/" class="btn btn-secondary">
                Cancel
              </a>
            </div>
          </form>
        </div>

        <div class="mt-8 card p-6 bg-blue-50 border border-blue-200">
          <h3 class="font-semibold text-blue-900 mb-2 flex items-center gap-2">
            <span>üí°</span>
            Tips for Successful Selling
          </h3>
          <ul class="text-sm text-blue-800 space-y-1">
            <li>‚Ä¢ Use clear, descriptive titles</li>
            <li>‚Ä¢ Provide detailed product descriptions</li>
            <li>‚Ä¢ Set competitive prices</li>
            <li>‚Ä¢ Add high-quality product images</li>
            <li>‚Ä¢ Set your seller location so COD meeting points are accurate</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { getToken, getCategories, createProduct, geocodeAddress, reverseGeocode, upsertMyLocation, type Category } from '../utils/api';

    const authRequired = document.getElementById('auth-required');
    const formContainer = document.getElementById('sell-form-container');
    const form = document.getElementById('sell-form') as HTMLFormElement;
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    const categorySelect = form?.querySelector('select[name="category_id"]') as HTMLSelectElement;

    const sellerAddressInput = document.getElementById('seller-address-input') as HTMLInputElement | null;
    const sellerGeocodeBtn = document.getElementById('seller-geocode-btn') as HTMLButtonElement | null;
    const sellerCurrentLocationBtn = document.getElementById('seller-current-location-btn') as HTMLButtonElement | null;
    const sellerLocationResult = document.getElementById('seller-location-result');
    const sellerFoundAddress = document.getElementById('seller-found-address');
    const sellerFoundCoords = document.getElementById('seller-found-coords');
    const sellerLocationWarning = document.getElementById('seller-location-warning');

    const sellSubmitBtn = document.getElementById('sell-submit-btn') as HTMLButtonElement | null;

    // Check authentication
    const token = getToken();
    if (!token) {
      authRequired?.classList.remove('hidden');
    } else {
      formContainer?.classList.remove('hidden');
      loadCategories();
      showSellerLocationWarning('Please set your seller location before listing a product.');
    }

    let sellerLocation: { latitude: number; longitude: number; address: string } | null = null;

    function showSellerLocationWarning(message: string) {
      if (!sellerLocationWarning) return;
      sellerLocationWarning.textContent = message;
      sellerLocationWarning.classList.remove('hidden');
    }

    function clearSellerLocationWarning() {
      sellerLocationWarning?.classList.add('hidden');
    }

    function setSellerLocation(loc: { latitude: number; longitude: number; address: string }) {
      sellerLocation = loc;

      if (sellerFoundAddress) sellerFoundAddress.textContent = loc.address;
      if (sellerFoundCoords) {
        sellerFoundCoords.textContent = `${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}`;
      }
      sellerLocationResult?.classList.remove('hidden');
      clearSellerLocationWarning();
    }

    function setButtonLoading(
      btn: HTMLButtonElement | null,
      loading: boolean,
      labelHtml: string,
      loadingText: string
    ) {
      if (!btn) return;
      if (loading) {
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span>${loadingText}`;
      } else {
        btn.disabled = false;
        btn.innerHTML = labelHtml;
      }
    }

    async function saveSellerLocation() {
      if (!token) throw new Error('Not authenticated');
      if (!sellerLocation) throw new Error('Seller location not set');
      await upsertMyLocation(token, sellerLocation);
    }

    async function loadCategories() {
      try {
        const categories: Category[] = await getCategories();
        if (categorySelect) {
          categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id.toString();
            option.textContent = `${category.icon || ''} ${category.name}`.trim();
            categorySelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load categories:', error);
      }
    }

    sellerGeocodeBtn?.addEventListener('click', async () => {
      errorDiv?.classList.add('hidden');
      clearSellerLocationWarning();

      const address = sellerAddressInput?.value?.trim() || '';
      if (!address) {
        showSellerLocationWarning('Please enter an address to find your location.');
        return;
      }

      setButtonLoading(sellerGeocodeBtn, true, '<span>üìç</span> Find Location', 'Finding...');

      try {
        const result = await geocodeAddress(address);
        setSellerLocation(result);
        setButtonLoading(sellerGeocodeBtn, false, '<span>üìç</span> Find Location', 'Finding...');
      } catch (error) {
        console.error('Seller geocoding failed:', error);
        showSellerLocationWarning('Could not find that address. Try a more specific address or city.');
        setButtonLoading(sellerGeocodeBtn, false, '<span>üìç</span> Find Location', 'Finding...');
      }
    });

    sellerCurrentLocationBtn?.addEventListener('click', () => {
      errorDiv?.classList.add('hidden');
      clearSellerLocationWarning();

      if (!navigator.geolocation) {
        showSellerLocationWarning('Geolocation is not supported by your browser.');
        return;
      }

      setButtonLoading(sellerCurrentLocationBtn, true, '<span>üéØ</span> Use Current Location', 'Getting...');

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          try {
            const result = await reverseGeocode(position.coords.latitude, position.coords.longitude);
            setSellerLocation(result);
            setButtonLoading(sellerCurrentLocationBtn, false, '<span>üéØ</span> Use Current Location', 'Getting...');
          } catch (error) {
            console.error('Seller reverse geocoding failed:', error);
            showSellerLocationWarning('Could not get address from your current location.');
            setButtonLoading(sellerCurrentLocationBtn, false, '<span>üéØ</span> Use Current Location', 'Getting...');
          }
        },
        (geoError) => {
          console.error('Geolocation error:', geoError);
          showSellerLocationWarning('Could not access your location. Please check browser permissions.');
          setButtonLoading(sellerCurrentLocationBtn, false, '<span>üéØ</span> Use Current Location', 'Getting...');
        }
      );
    });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!token) {
        window.location.href = '/login';
        return;
      }

      errorDiv?.classList.add('hidden');
      successDiv?.classList.add('hidden');

      const formData = new FormData(form);
      const data = {
        category_id: parseInt(formData.get('category_id') as string),
        title: formData.get('title') as string,
        description: formData.get('description') as string,
        price: parseFloat(formData.get('price') as string),
        image_url: (formData.get('image_url') as string) || undefined,
      };

      // Validation
      if (!data.category_id || !data.title || !data.description || !data.price) {
        if (errorDiv) {
          errorDiv.textContent = 'Please fill in all required fields';
          errorDiv.classList.remove('hidden');
        }
        return;
      }

      if (data.price < 0) {
        if (errorDiv) {
          errorDiv.textContent = 'Price must be a positive number';
          errorDiv.classList.remove('hidden');
        }
        return;
      }

      if (!sellerLocation) {
        showSellerLocationWarning('Please set your seller location before listing a product.');
        return;
      }

      setButtonLoading(sellSubmitBtn, true, '<span>üì¶</span> List Product', 'Saving location...');

      try {
        await saveSellerLocation();

        if (sellSubmitBtn) {
          sellSubmitBtn.innerHTML = `<span class="spinner"></span>Creating product...`;
        }

        const product = await createProduct(token, data);

        if (successDiv) {
          successDiv.textContent = 'Product listed successfully! Redirecting...';
          successDiv.classList.remove('hidden');
        }

        setTimeout(() => {
          window.location.href = `/product/${product.id}`;
        }, 1500);
      } catch (error) {
        console.error('Failed to create product:', error);
        if (errorDiv) {
          errorDiv.textContent = 'Failed to create product. Please try again.';
          errorDiv.classList.remove('hidden');
        }

        setButtonLoading(sellSubmitBtn, false, '<span>üì¶</span> List Product', 'Saving location...');
      }
    });
  </script>
</MainLayout>
